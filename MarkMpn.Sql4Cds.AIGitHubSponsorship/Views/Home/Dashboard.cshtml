@{
    ViewData["Title"] = "Dashboard - SQL 4 CDS AI Credits";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="mb-4 d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    @if (!string.IsNullOrEmpty(ViewBag.AvatarUrl))
                    {
                        <img src="@ViewBag.AvatarUrl" alt="@ViewBag.Username" style="width: 60px; height: 60px; border-radius: 50%; margin-right: 15px; border: 2px solid var(--gh-accent-blue);">
                    }
                    else
                    {
                        <i class="bi bi-person-circle me-3" style="font-size: 3rem; color: var(--gh-accent-blue);"></i>
                    }
                    <h1 class="display-5 fw-bold mb-0">
                        Welcome, @ViewBag.Username!
                    </h1>
                </div>
                <div>
                    <a asp-controller="Home" asp-action="Logout" class="btn btn-outline-secondary">
                        <i class="bi bi-box-arrow-right me-2"></i>Sign Out
                    </a>
                </div>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-body p-5">
                    <div class="alert alert-success d-flex align-items-center mb-4" role="alert">
                        <i class="bi bi-check-circle-fill me-2" style="font-size: 1.5rem;"></i>
                        <div>
                            <strong>Successfully authenticated!</strong><br/>
                            <small>Your GitHub account has been verified.</small>
                        </div>
                    </div>

                    <h2 class="h3 mb-4">Your Sponsorship Status</h2>
                    
                    <div class="row mb-4 g-3">
                        <div class="col-md-6">
                            <div class="card h-100" style="background: linear-gradient(135deg, rgba(88, 166, 255, 0.1) 0%, rgba(188, 140, 255, 0.1) 100%); border: 1px solid rgba(88, 166, 255, 0.3);">
                                <div class="card-body p-4 d-flex flex-column justify-content-between">
                                    <div class="text-center">
                                        <i class="bi bi-award" style="font-size: 3rem; color: var(--gh-accent-blue);"></i>
                                        <h3 class="h4 mt-3 mb-2">Sponsorship Level</h3>
                                        <p class="mb-1 fw-semibold" style="color: var(--gh-text-primary);">@ViewBag.SponsorshipLevel</p>
                                        <p class="text-muted mb-0 small">Free AI credits are based on your active GitHub sponsorship</p>
                                    </div>
                                    <div class="mt-3 text-center">
                                        <div style="max-width: 300px; margin-left: auto; margin-right: auto;">
                                            <a href="https://github.com/sponsors/MarkMpn" target="_blank" class="btn btn-sm btn-sponsor-gradient btn-sponsor-wide" style="padding: 0.5rem 1.25rem; width: 100%;">
                                                <i class="bi bi-heart me-1"></i> Update sponsorship level
                                            </a>
                                            <form asp-controller="Home" asp-action="RefreshSponsorship" method="post" class="d-inline">
                                                @Html.AntiForgeryToken()
                                                <button type="submit" class="btn btn-outline-secondary btn-sm mt-3" style="width: 100%;">
                                                    <i class="bi bi-arrow-clockwise me-1"></i> Refresh sponsorship status
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body p-4">
                                    <h4 class="h5 mb-3">
                                        <i class="bi bi-key-fill me-2" style="color: var(--gh-accent-purple);"></i>
                                        Your API Key
                                    </h4>
                                    <div class="mb-3">
                                        <p class="text-muted small mb-2">Use this key to access AI services. Keep it secret.</p>
                                        <div class="input-group">
                                            <input type="text" class="form-control" value="@ViewBag.ApiKey" readonly style="background-color: var(--gh-bg-tertiary); color: var(--gh-text-secondary); border: 1px solid var(--gh-border);">
                                            <button class="btn btn-outline-secondary" type="button" @(ViewBag.ApiKey == "sk_pending_verification" ? "disabled" : "")>
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h3 class="h4 mb-3">AI Credits Overview</h3>
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="text-muted">Available Credits</span>
                                        <i class="bi bi-stars" style="color: var(--gh-accent-blue);"></i>
                                    </div>
                                    <h3 class="h2 mb-0" style="color: var(--gh-accent-blue);">@ViewBag.TokensRemaining</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="text-muted">Used This Month</span>
                                        <i class="bi bi-graph-up" style="color: var(--gh-accent-green);"></i>
                                    </div>
                                    <h3 class="h2 mb-0" style="color: var(--gh-accent-green);">@ViewBag.TokensUsedThisMonth</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="text-muted">Monthly Allowance</span>
                                        <i class="bi bi-trophy" style="color: var(--gh-accent-purple);"></i>
                                    </div>
                                    <h3 class="h2 mb-0" style="color: var(--gh-accent-purple);">@ViewBag.TokensAllowed</h3>
                                </div>
                            </div>
                        </div>
                    </div>

                    <p class="mb-4">
                        Each credit is equivalent to 1 <code>gpt-5-nano</code> token. <code>gpt-5</code> tokens consume 25 credits each.
                    </p>

                    @{ var tokensAllowed = ViewBag.TokensAllowed as int? ?? 0; }
                    @if (tokensAllowed == 0)
                    {
                        <div class="alert alert-info d-flex align-items-start" role="alert">
                            <i class="bi bi-info-circle-fill me-2 mt-1"></i>
                            <div>
                                <strong>Not a sponsor yet?</strong><br/>
                                <small>
                                    Become a GitHub Sponsor to unlock AI credits and support the SQL 4 CDS project. 
                                    <a href="https://github.com/sponsors/MarkMpn" target="_blank" style="color: #f5576c; font-weight: 600;">Sponsor now</a>
                                </small>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-body p-4">
                    <h3 class="h5 mb-3">
                        <i class="bi bi-book me-2"></i>
                        Using Your API Key
                    </h3>
                    <p class="mb-3">Once you have your API key, you can use it to access AI-powered features in SQL 4 CDS:</p>
                    <div class="bg-dark p-3 rounded" style="background-color: var(--gh-bg-tertiary) !important;">
                        <code style="color: var(--gh-text-primary);">
                            <span style="color: var(--gh-accent-purple);">// Configure your API key in SQL 4 CDS</span><br/>
                            <span style="color: var(--gh-accent-blue);">Settings</span>.<span style="color: var(--gh-accent-green);">AIApiKey</span> = <span style="color: #f778ba);">"your-api-key-here"</span>;
                        </code>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .alert-success {
        background: linear-gradient(135deg, rgba(63, 185, 80, 0.1) 0%, rgba(88, 166, 255, 0.1) 100%);
        border: 1px solid rgba(63, 185, 80, 0.3);
        color: var(--gh-accent-green);
    }
    
    .form-control:focus {
        background-color: var(--gh-bg-tertiary) !important;
        border-color: var(--gh-accent-blue);
        color: var(--gh-text-primary);
    }
</style>
